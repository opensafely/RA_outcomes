
. cap mkdir ./output/time_series

. cap mkdir ./output/tables

. cap mkdir ./output/tempdata

. 
. * Update outpatient appointments all file to exclude rheumatology appointment
> s 
. tempfile datafile 

. import delimited "./output/measures/join/measure_op_appt_all_rate.csv", clear
(4 vars, 56 obs)

. rename value all_op_value

. rename op_appt all_op_appt 

. describe 

Contains data
  obs:            56                          
 vars:             4                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
all_op_appt     int     %8.0g                 
population      int     %8.0g                 
all_op_value    float   %9.0g                 
date            str10   %10s                  
-------------------------------------------------------------------------------
Sorted by: 
     Note: Dataset has changed since last saved.

. save `datafile'
file /tmp/St00015.000001 saved

. import delimited "./output/measures/join/measure_op_appt_rate.csv", clear
(4 vars, 56 obs)

. merge 1:1 date using `datafile', keepusing(all_op_value all_op_appt)

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                                56  (_merge==3)
    -----------------------------------------

. describe 

Contains data
  obs:            56                          
 vars:             7                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
op_appt         int     %8.0g                 
population      int     %8.0g                 
value           float   %9.0g                 
date            str10   %10s                  
all_op_appt     int     %8.0g                 
all_op_value    float   %9.0g                 
_merge          byte    %23.0g     _merge     
-------------------------------------------------------------------------------
Sorted by: date
     Note: Dataset has changed since last saved.

. rename value rheum_op_value

. rename op_appt rheum_op_appt 

. gen value = all_op_value - rheum_op_value

. gen op_appt_all_n = all_op_appt - rheum_op_appt 

. drop all_op_value rheum_op_value _merge all_op_appt rheum_op_appt

. export delimited "./output/measures/join/measure_op_appt_all_n_rate.csv"
file ./output/measures/join/measure_op_appt_all_n_rate.csv saved

. 
. * Outpatient appointments amd hospitalisations
. * Autocorrelation indicates no autocorrelation for op_appt 
. local a "op_appt op_appt_all_n hosp_ra hosp_all med_gc med_opioid_strong med_
> opioid_weak med_ssri med_nsaid"

. local b "op_appt op_appt_all_n ra_hosp all_admissions gc_prescribing opioid_s
> trong_prescribing opioid_weak_prescribing ssri_prescribing nsaid_prescribing"

. local n: word count `a'

. forvalues i=1/`n' {
  2.     local file: word `i' of `a'
  3.     local var: word `i' of `b'
  4. 
.     import delimited "./output/measures/join/measure_`file'_rate.csv", clear 
>    //get csv
  5.     gen temp_date=date(date, "YMD")
  6.     format temp_date %td
  7.     gen month=mofd(temp_date)
  8.     format month %tm
  9.     drop temp_date
 10.     *Value to percentage of population
.     gen `var'_round = round(`var', 5)
 11.     gen pop_round = round(population, 5)
 12.     gen percent_round = (`var'_round/pop_round)*100
 13.     gen percent = value*100
 14.     count if percent_round!=percent
 15.     drop if percent==0
 16.     label variable percent_round "Percent of population"
 17.     export delimited "./output/measures/join/measure_`file'_round_rate.csv
> "
 18.     *Set time series
.     tsset month 
 19.     itsa percent_round, trperiod(2020m4) figure single lag(1) posttrend
 20.     parmest, label saving("./output/tempdata/`file'_itsa_output", replace)
 21.     graph export ./output/time_series/itsa_`file'.svg, as(svg) replace
 22.     actest, lags(6)
 23.     keep date percent_round
 24.     export delimited "./output/time_series/plot_data_`file'.csv"
 25.     }
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_op_appt_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         50          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/op_appt_itsa_output.dta saved
(note: file ./output/time_series/itsa_op_appt.svg not found)
(file ./output/time_series/itsa_op_appt.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_op_appt.csv saved
(4 vars, 56 obs)
  56
(0 observations deleted)
file ./output/measures/join/measure_op_appt_all_n_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         20          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/tempdata/op_appt_all_n_itsa_output.dta not found)
file ./output/tempdata/op_appt_all_n_itsa_output.dta saved
(note: file ./output/time_series/itsa_op_appt_all_n.svg not found)
(file ./output/time_series/itsa_op_appt_all_n.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_op_appt_all_n.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_hosp_ra_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/hosp_ra_itsa_output.dta saved
(note: file ./output/time_series/itsa_hosp_ra.svg not found)
(file ./output/time_series/itsa_hosp_ra.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_hosp_ra.csv saved
(4 vars, 56 obs)
  56
(0 observations deleted)
file ./output/measures/join/measure_hosp_all_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         30          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/hosp_all_itsa_output.dta saved
(note: file ./output/time_series/itsa_hosp_all.svg not found)
(file ./output/time_series/itsa_hosp_all.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_hosp_all.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_med_gc_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/med_gc_itsa_output.dta saved
(note: file ./output/time_series/itsa_med_gc.svg not found)
(file ./output/time_series/itsa_med_gc.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_med_gc.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_med_opioid_strong_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/med_opioid_strong_itsa_output.dta saved
(note: file ./output/time_series/itsa_med_opioid_strong.svg not found)
(file ./output/time_series/itsa_med_opioid_strong.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_med_opioid_strong.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_med_opioid_weak_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/med_opioid_weak_itsa_output.dta saved
(note: file ./output/time_series/itsa_med_opioid_weak.svg not found)
(file ./output/time_series/itsa_med_opioid_weak.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_med_opioid_weak.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_med_ssri_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/med_ssri_itsa_output.dta saved
(note: file ./output/time_series/itsa_med_ssri.svg not found)
(file ./output/time_series/itsa_med_ssri.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_med_ssri.csv saved
(4 vars, 56 obs)
  0
(0 observations deleted)
file ./output/measures/join/measure_med_nsaid_round_rate.csv saved
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  0,        52) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
_percent_r~d |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
file ./output/tempdata/med_nsaid_itsa_output.dta saved
(note: file ./output/time_series/itsa_med_nsaid.svg not found)
(file ./output/time_series/itsa_med_nsaid.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
file ./output/time_series/plot_data_med_nsaid.csv saved

. 
. * Medium of rheumatology outpatient appointments
. import delimited "./output/measures/join/measure_op_appt_medium_rate.csv", cl
> ear        //get csv
(5 vars, 560 obs)

. drop if op_appt_medium==. | op_appt_medium>=3
(448 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. * Generate new population as all those with medium described
. bys date: egen pop_new = total(population)

. * Calculate rate
. gen percent = (op_appt/pop_new)*100

. drop population

. label variable percent "Percent of population"

. *Set time series
. tsset op_appt_medium month 
       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

. itsa percent, trperiod(2020m4) treatid(2) figure lag(1) posttrend


       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =        112
maximum lag: 1                                  F(  7,       104) =    1661.01
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |  -.1396942   .0464917    -3.00   0.003    -.2318891   -.0474994
          _z |  -18.06027   .4800059   -37.63   0.000    -19.01214    -17.1084
        _z_t |   .1891386   .0713104     2.65   0.009     .0477274    .3305497
    _x2020m4 |   .4773764   .4716309     1.01   0.314    -.4578853    1.412638
  _x_t2020m4 |   .1444409   .0467575     3.09   0.003     .0517191    .2371627
  _z_x2020m4 |  -.3504157   .6906166    -0.51   0.613    -1.719934    1.019103
_z_x_t2020m4 |  -.2109253   .0721461    -2.92   0.004    -.3539938   -.0678568
       _cons |   34.28411   .3390974   101.10   0.000     33.61166    34.95655
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |    -.01704   .0107891    -1.58   0.117    -.0384352    .0043551
    Controls |   .0047467   .0107408     0.44   0.659    -.0165528    .0260461
-------------+----------------------------------------------------------------
  Difference |  -.0217867    .015224    -1.43   0.155    -.0519764     .008403
------------------------------------------------------------------------------

. parmest, label saving("./output/tempdata/op_appt_medium_itsa_output", replace
> )
file ./output/tempdata/op_appt_medium_itsa_output.dta saved

. graph export ./output/time_series/itsa_op_appt_medium.svg, as(svg) replace
(note: file ./output/time_series/itsa_op_appt_medium.svg not found)
(file ./output/time_series/itsa_op_appt_medium.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |      0.250      1    0.6174 |   1 |      0.250      1    0.6174
   1 -  2  |      0.381      2    0.8264 |   2 |      0.111      1    0.7386
   1 -  3  |      1.941      3    0.5847 |   3 |      1.460      1    0.2269
   1 -  4  |      1.961      4    0.7429 |   4 |      0.000      1    0.9944
   1 -  5  |      2.301      5    0.8062 |   5 |      0.228      1    0.6334
   1 -  6  |      2.535      6    0.8645 |   6 |      0.065      1    0.7991
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. * Daycase admissions vs regular/ordinary 
. import delimited "./output/measures/join/measure_hosp_ra_daycase_rate.csv", c
> lear       //get csv
(5 vars, 336 obs)

. drop if ra_daycase==. | ra_daycase>=4
(168 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. gen postcovid=(temp_date>=date("23/03/2020", "DMY"))

. drop temp_date

. * Generate new population as all those with medium described
. bys date: egen pop_new = total(population)

. * Calculate percentage
. gen percent = (ra_hosp/pop_new)*100

. drop population

. label variable percent "Percent of population"

. *Set time series
. tsset ra_daycase month
       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

. newey percent ra_daycase##postcovid, lag(1) force 

Regression with Newey-West standard errors      Number of obs     =        168
maximum lag: 1                                  F(  5,       162) =    2596.77
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
     percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
  ra_daycase |
          2  |  -6.168743   .0967797   -63.74   0.000    -6.359855    -5.97763
          3  |  -6.306094   .1182488   -53.33   0.000    -6.539602   -6.072587
             |
 1.postcovid |   .0277467   .1076333     0.26   0.797    -.1847984    .2402918
             |
  ra_daycase#|
   postcovid |
        2 1  |  -.1241073   .1200592    -1.03   0.303    -.3611902    .1129756
        3 1  |   .0229629   .1378732     0.17   0.868    -.2492974    .2952232
             |
       _cons |   7.497223   .0852579    87.94   0.000     7.328863    7.665583
------------------------------------------------------------------------------

. * Itsa compared treat group to all other groups
. itsa percent, trperiod(2020m4) treatid(2) figure lag(1) posttrend


       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =        168
maximum lag: 1                                  F(  7,       160) =       9.52
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |   .0062241   .2603734     0.02   0.981    -.5079878     .520436
          _z |   -2.87814   1.717143    -1.68   0.096    -6.269328    .5130479
        _z_t |  -.0250101   .2605981    -0.10   0.924    -.5396657    .4896455
    _x2020m4 |   -.018227    2.09239    -0.01   0.993    -4.150491    4.114037
  _x_t2020m4 |  -.0054335   .2643578    -0.02   0.984    -.5275142    .5166472
  _z_x2020m4 |   .0397158   2.095368     0.02   0.985    -4.098429    4.177861
_z_x_t2020m4 |   .0244176   .2645839     0.09   0.927    -.4981096    .5469448
       _cons |   4.309943    1.71654     2.51   0.013     .9199456    7.699941
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |   .0001981   .0018651     0.11   0.916    -.0034852    .0038814
    Controls |   .0007906   .0378724     0.02   0.983    -.0740035    .0755848
-------------+----------------------------------------------------------------
  Difference |  -.0005925   .0379183    -0.02   0.988    -.0754773    .0742923
------------------------------------------------------------------------------

. parmest, label saving("./output/tempdata/ra_daycase_itsa_output", replace)
file ./output/tempdata/ra_daycase_itsa_output.dta saved

. graph export ./output/time_series/itsa_hosp_ra_daycase.svg, as(svg) replace
(note: file ./output/time_series/itsa_hosp_ra_daycase.svg not found)
(file ./output/time_series/itsa_hosp_ra_daycase.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |    162.448      1    0.0000 |   1 |    162.448      1    0.0000
   1 -  2  |    162.580      2    0.0000 |   2 |     54.798      1    0.0000
   1 -  3  |    162.582      3    0.0000 |   3 |     32.807      1    0.0000
   1 -  4  |    162.652      4    0.0000 |   4 |     23.612      1    0.0000
   1 -  5  |    162.671      5    0.0000 |   5 |     18.367      1    0.0000
   1 -  6  |    162.673      6    0.0000 |   6 |     15.021      1    0.0001
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. 
. * Method of admission - elective vs emergency
. * Graphs stratified by admission method
. import delimited using ./output/measures/join/measure_hosp_ra_elective_rate.c
> sv, numericcols(3) clear
(5 vars, 560 obs)

. * Drop if ra_elective missing or is mother-baby record
. drop if (ra_elective=="" | ra_elective=="31" | ra_elective=="32" | ra_electiv
> e=="82" | ra_elective=="83")
(56 observations deleted)

. table ra_elective

----------------------
ra_electi |
ve        |      Freq.
----------+-----------
       11 |         56
       12 |         56
       13 |         56
       21 |         56
       22 |         56
       23 |         56
       24 |         56
       25 |         56
       2A |         56
----------------------

. * generate binary variable for elective admissions 
. gen ra_elective_n = (ra_elective == "81" | ra_elective == "11" | ra_elective 
> == "11.0" | ra_elective == "12" | ra_elective == "12.0" | ra_elective == "13"
> | ra_elective == "13.0")

. tab ra_elective*

ra_electiv |     ra_elective_n
         e |         0          1 |     Total
-----------+----------------------+----------
        11 |         0         56 |        56 
        12 |         0         56 |        56 
        13 |         0         56 |        56 
        21 |        56          0 |        56 
        22 |        56          0 |        56 
        23 |        56          0 |        56 
        24 |        56          0 |        56 
        25 |        56          0 |        56 
        2A |        56          0 |        56 
-----------+----------------------+----------
     Total |       336        168 |       504 

. bys ra_elective_n: table ra_elective

-------------------------------------------------------------------------------
-> ra_elective_n = 0

----------------------
ra_electi |
ve        |      Freq.
----------+-----------
       21 |         56
       22 |         56
       23 |         56
       24 |         56
       25 |         56
       2A |         56
----------------------

-------------------------------------------------------------------------------
-> ra_elective_n = 1

----------------------
ra_electi |
ve        |      Freq.
----------+-----------
       11 |         56
       12 |         56
       13 |         56
----------------------

. * Update number of hospitalisations and population to combine all categories 
> combined
. bys date ra_elective_n: egen ra_hosp_n = total(ra_hosp)

. bys date: egen population_n = total(population)

. drop ra_elective ra_hosp population value

. * Elective variable is now proportion of all hospitalisations that are electi
> ve
. * Keep only elective as elective==0 is opposite i.e. same information 
. drop if ra_elective_n == 0
(336 observations deleted)

. * Calculate proportion
. gen percent = (ra_hosp_n/population_n)*100

. duplicates drop

Duplicates in terms of all variables

(112 observations deleted)

. * Format date
. gen dateA = date(date, "YMD")

. drop date

. format dateA %td

. gen month=mofd(dateA)

. format month %tm

. *Set time series
. tsset month 
        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

. itsa percent, trperiod(2020m4) figure single lag(1) posttrend


        time variable:  month, 2019m4 to 2023m11
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         56
maximum lag: 1                                  F(  3,        52) =       1.22
                                                Prob > F          =     0.3131

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |  -.0114685   .0173938    -0.66   0.513    -.0463718    .0234348
    _x2020m4 |  -.0384847    .149569    -0.26   0.798    -.3386169    .2616475
  _x_t2020m4 |   .0133995   .0176202     0.76   0.450    -.0219581     .048757
       _cons |    5.11641   .0892043    57.36   0.000     4.937409    5.295412
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |   .0019309   .0026808     0.72   0.475    -.0034485    .0073104
------------------------------------------------------------------------------

. parmest, label saving("./output/tempdata/ra_elective_itsa_output", replace)
(note: file ./output/tempdata/ra_elective_itsa_output.dta not found)
file ./output/tempdata/ra_elective_itsa_output.dta saved

. graph export ./output/time_series/itsa_ra_elective.svg, as(svg) replace
(note: file ./output/time_series/itsa_ra_elective.svg not found)
(file ./output/time_series/itsa_ra_elective.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |      0.105      1    0.7461 |   1 |      0.105      1    0.7461
   1 -  2  |      3.216      2    0.2003 |   2 |      3.007      1    0.0829
   1 -  3  |      3.364      3    0.3389 |   3 |      0.040      1    0.8423
   1 -  4  |      5.271      4    0.2606 |   4 |      0.953      1    0.3290
   1 -  5  |      5.678      5    0.3388 |   5 |      0.094      1    0.7595
   1 -  6  |      7.716      6    0.2596 |   6 |      3.979      1    0.0461
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. * Append results together
. tempfile tempfile

. use "./output/tempdata/ra_elective_itsa_output", clear

. gen outcome = "ra_elective"

. save `tempfile', replace
(note: file /tmp/St00015.000002 not found)
file /tmp/St00015.000002 saved

. 
. foreach var in op_appt op_appt_all_n hosp_ra /*hosp_ra_emergency*/ hosp_all m
> ed_gc med_opioid_strong med_opioid_weak med_ssri med_nsaid op_appt_medium ra_
> daycase {
  2.     use "./output/tempdata/`var'_itsa_output", clear
  3.     gen outcome = "`var'"
  4.     append using `tempfile'
  5.     save `tempfile', replace
  6. }
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str7, now str11 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str7, now str13 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str8, now str13 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str6, now str13 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str15, now str17 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str8, now str17 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable estimate was byte, now double to accommodate using data's
       values)
(note: variable stderr was byte, now double to accommodate using data's
       values)
(note: variable t was byte, now double to accommodate using data's values)
(note: variable p was byte, now double to accommodate using data's values)
(note: variable min95 was byte, now double to accommodate using data's
       values)
(note: variable max95 was byte, now double to accommodate using data's
       values)
(note: variable outcome was str9, now str17 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable outcome was str14, now str17 to accommodate using data's
       values)
file /tmp/St00015.000002 saved
(note: variable outcome was str10, now str17 to accommodate using data's
       values)
file /tmp/St00015.000002 saved

. use `tempfile', clear 

. describe 

Contains data from /tmp/St00015.000002
  obs:            56                          
 vars:            10                          30 May 2024 13:21
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
parm            str12   %12s                  Parameter name
label           str8    %9s                   Parameter label
estimate        double  %10.0g                Parameter estimate
stderr          double  %10.0g                SE of parameter estimate
dof             int     %10.0g                Degrees of freedom
t               double  %10.0g                t-test statistic
p               double  %10.0g                P-value
min95           double  %10.0g                Lower 95% confidence limit
max95           double  %10.0g                Upper 95% confidence limit
outcome         str17   %17s                  
-------------------------------------------------------------------------------
Sorted by: 

. export delimited using "./output/tables/all_itsa_output.csv", replace
(note: file ./output/tables/all_itsa_output.csv not found)
file ./output/tables/all_itsa_output.csv saved

. 
. /* Outpatient medium
> import delimited "./output/measures/join/measure_op_appt_medium_rate.csv", cl
> ear        //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(op_appt_medium) modify
> drop if op_appt_medium==. | op_appt_medium>=3
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> * Generate new population as all those with medium described
> bys date: egen pop_new = total(population)
> * Calculate rate
> gen rate = (op_appt/pop_new)*100000
> label variable rate "Rate of op appts per 100,000"
> *Set time series
> tsset op_appt_medium month
> newey rate i.op_appt_medium##i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_op_appt_medium.svg, as(svg) replac
> e
> * Itsa model
> itsa rate, trperiod(2020m4) figure treatid(1) lag(1)
> graph export ./output/time_series/itsa_appt_medium.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (op_appt_med
> ium) clear
> export delimited using ./output/time_series/tsreg_op_appt_medium.csv, replace
> 
> * Hospitalisations
> local a "cardiac ild ra sepsis vasculitis"
> forvalues i=1/5 {
>     local c: word `i' of `a' 
>                 import delimited "./output/measures/join/measure_hosp_`c'_rat
> e.csv", clear      //get csv
>         putexcel set ./output/time_series/tsreg_tables, sheet(hosp_`c') modif
> y
>                 gen temp_date=date(date, "YMD")
>                 format temp_date %td
>                 gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
>                 gen month=mofd(temp_date)
>                 format month %tm
>                 drop temp_date
>                 *Value to rate per 100k
>                 gen rate = value*100000
>                 label variable rate "Rate of hospitalisations `c' per 100,000
> "
>                 *Set time series
>                 tsset month 
>                 newey rate i.postcovid, lag(1) force
>         *Export results
>         putexcel E1=("Number of obs") G1=(e(N))
>         putexcel E2=("F") G2=(e(F))
>         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
>         matrix a = r(table)'
>         putexcel A6 = matrix(a), rownames
>         putexcel save
>         *quietly margins postcovid
>         *marginsplot
>         *graph export ./output/time_series/margins_hosp_`c'.svg, as(svg) repl
> ace
>         itsa rate, trperiod(2020m4) figure single lag(1)
>         graph export ./output/time_series/itsa_`c'.svg, as(svg) replace
>         import excel using ./output/time_series/tsreg_tables.xlsx, sheet (hos
> p_`c') clear
>         export delimited using ./output/time_series/tsreg_hosp_`c'.csv, repla
> ce
>         }
> 
> * RA daycase
> import delimited "./output/measures/join/measure_hosp_ra_daycase_rate.csv", c
> lear       //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(hosp_ra_daycase) modify
> drop if ra_daycase==. | ra_daycase>=4
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> * Generate new population as all those with type of admission
> bys date: egen pop_new = total(population)
> * Calculate rate
> gen rate = (ra_hosp/pop_new)*100000
> label variable rate "Rate of op appts per 100,000"
> *Set time series
> tsset ra_daycase month
> newey rate i.ra_daycase##i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_hosp_ra_daycase.svg, as(svg) repla
> ce
> * Itsa model
> itsa rate, trperiod(2020m4) figure treatid(2) lag(1)
> graph export ./output/time_series/itsa_ra_daycase.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (hosp_ra_day
> case) clear
> export delimited using ./output/time_series/tsreg_hosp_ra_daycase.csv, replac
> e
> 
> import delimited "./output/measures/join/measure_med_gc_rate.csv", clear     
>    //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(med_gc) modify
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> *Value to rate per 100k
> gen rate = value*100000
> label variable rate "Rate of GC prescribing per 100,000"
> *Set time series
> tsset month 
> newey rate i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_med_gc.svg, as(svg) replace
> itsa rate, trperiod(2020m4) figure single lag(1)
> graph export ./output/time_series/itsa_med_gc.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (med_gc) cle
> ar
> export delimited using ./output/time_series/tsreg_med_gc.csv, replace

end of do-file

. . file open output using "/tmp/time_series.do.Bqln.out", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


