
. cap mkdir ./output/time_series

. 
. * Outpatient appointments
. * Autocorrelation indicates no autocorrelation for op_appt 
. foreach file in op_appt hosp_ra hosp_ra_emergency med_gc med_opioid_strong me
> d_opioid_weak med_ssri {
  2.     import delimited "./output/measures/join/measure_`file'_rate.csv", cle
> ar    //get csv
  3.     gen temp_date=date(date, "YMD")
  4.     format temp_date %td
  5.     gen month=mofd(temp_date)
  6.     format month %tm
  7.     drop temp_date
  8.     *Value to percentage of population
.     gen percent = value*100
  9.     label variable percent "Percent of population"
 10.     *Set time series
.     tsset month 
 11.     itsa percent, trperiod(2020m4) figure single lag(1) posttrend
 12.     graph export ./output/time_series/itsa_`file'.svg, as(svg) replace
 13.     actest, lags(6)
 14.     }
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         70          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_op_appt.svg not found)
(file ./output/time_series/itsa_op_appt.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_hosp_ra.svg not found)
(file ./output/time_series/itsa_hosp_ra.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_hosp_ra_emergency.svg not found)
(file ./output/time_series/itsa_hosp_ra_emergency.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_gc.svg not found)
(file ./output/time_series/itsa_med_gc.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_opioid_strong.svg not found)
(file ./output/time_series/itsa_med_opioid_strong.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_opioid_weak.svg not found)
(file ./output/time_series/itsa_med_opioid_weak.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_ssri.svg not found)
(file ./output/time_series/itsa_med_ssri.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. import delimited "./output/measures/join/measure_op_appt_medium_rate.csv", cl
> ear        //get csv
(5 vars, 360 obs)

. drop if op_appt_medium==. | op_appt_medium>=3
(288 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. *Value to percentage of population
. gen percent = value*100

. label variable percent "Percent of population"

. *Set time series
. tsset op_appt_medium month 
       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

. itsa percent, trperiod(2020m4) treatid(1) figure lag(1) posttrend


       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         72
maximum lag: 1                                  F(  7,        64) =       1.12
                                                Prob > F          =     0.3613

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |  -.0021333   .1656509    -0.01   0.990    -.3330591    .3287925
          _z |   .3536673   1.274019     0.28   0.782    -2.191478    2.898813
        _z_t |  -.1385125   .1984557    -0.70   0.488    -.5349735    .2579484
    _x2020m4 |    .156581   1.508008     0.10   0.918    -2.856012    3.169174
  _x_t2020m4 |  -.0212754    .168077    -0.13   0.900    -.3570477    .3144969
  _z_x2020m4 |   2.024969   1.724499     1.17   0.245    -1.420114    5.470053
_z_x_t2020m4 |   .0897153   .2041086     0.44   0.662    -.3180385    .4974692
       _cons |   70.11807    .908852    77.15   0.000     68.30243    71.93371
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |  -.0722059   .0380257    -1.90   0.062    -.1481709    .0037591
    Controls |  -.0234087   .0462565    -0.51   0.615    -.1158167    .0689993
-------------+----------------------------------------------------------------
  Difference |  -.0487972     .05988    -0.81   0.418    -.1684212    .0708269
------------------------------------------------------------------------------

. graph export ./output/time_series/itsa_op_appt_medium.svg, as(svg) replace
(note: file ./output/time_series/itsa_op_appt_medium.svg not found)
(file ./output/time_series/itsa_op_appt_medium.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |      1.048      1    0.3061 |   1 |      1.048      1    0.3061
   1 -  2  |      2.064      2    0.3564 |   2 |      1.245      1    0.2645
   1 -  3  |      2.617      3    0.4545 |   3 |      0.898      1    0.3434
   1 -  4  |      7.170      4    0.1271 |   4 |      2.928      1    0.0871
   1 -  5  |      8.270      5    0.1420 |   5 |      0.504      1    0.4779
   1 -  6  |     11.475      6    0.0748 |   6 |      2.992      1    0.0837
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. import delimited "./output/measures/join/measure_hosp_ra_daycase_rate.csv", c
> lear       //get csv
(5 vars, 216 obs)

. drop if ra_daycase==. | ra_daycase>=4
(108 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. *Value to percentage of population
. gen percent = value*100

. label variable percent "Percent of population"

. *Set time series
. tsset ra_daycase month
       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

. itsa percent, trperiod(2020m4) treatid(1) contid(2) figure lag(1) posttrend


       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         72
maximum lag: 1                                  F(  7,        64) =       2.10
                                                Prob > F          =     0.0560

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |  -.1679339   .0859389    -1.95   0.055    -.3396165    .0037488
          _z |  -1.111613   .6442148    -1.73   0.089     -2.39858    .1753535
        _z_t |    .124519   .0916276     1.36   0.179    -.0585282    .3075662
    _x2020m4 |   .7362584   .8248883     0.89   0.375    -.9116455    2.384162
  _x_t2020m4 |   .1611322   .0946927     1.70   0.094    -.0280383    .3503027
  _z_x2020m4 |  -.1437018   .8593472    -0.17   0.868    -1.860445    1.573042
_z_x_t2020m4 |  -.1252072   .1002064    -1.25   0.216    -.3253925    .0749781
       _cons |   11.27913   .5850231    19.28   0.000     10.11041    12.44785
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |  -.0074899    .010559    -0.71   0.481    -.0285838    .0136041
    Controls |  -.0068017     .04101    -0.17   0.869    -.0887286    .0751253
-------------+----------------------------------------------------------------
  Difference |  -.0006882   .0423475    -0.02   0.987    -.0852871    .0839107
------------------------------------------------------------------------------

. graph export ./output/time_series/itsa_hosp_ra_daycase.svg, as(svg) replace
(note: file ./output/time_series/itsa_hosp_ra_daycase.svg not found)
(file ./output/time_series/itsa_hosp_ra_daycase.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |      0.333      1    0.5636 |   1 |      0.333      1    0.5636
   1 -  2  |      2.858      2    0.2395 |   2 |      2.404      1    0.1211
   1 -  3  |      7.176      3    0.0665 |   3 |      4.503      1    0.0338
   1 -  4  |      7.195      4    0.1259 |   4 |      0.120      1    0.7290
   1 -  5  |     11.919      5    0.0359 |   5 |      1.524      1    0.2170
   1 -  6  |     11.971      6    0.0626 |   6 |      0.007      1    0.9348
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. 
. /* Outpatient medium
> import delimited "./output/measures/join/measure_op_appt_medium_rate.csv", cl
> ear        //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(op_appt_medium) modify
> drop if op_appt_medium==. | op_appt_medium>=3
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> * Generate new population as all those with medium described
> bys date: egen pop_new = total(population)
> * Calculate rate
> gen rate = (op_appt/pop_new)*100000
> label variable rate "Rate of op appts per 100,000"
> *Set time series
> tsset op_appt_medium month
> newey rate i.op_appt_medium##i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_op_appt_medium.svg, as(svg) replac
> e
> * Itsa model
> itsa rate, trperiod(2020m4) figure treatid(1) lag(1)
> graph export ./output/time_series/itsa_appt_medium.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (op_appt_med
> ium) clear
> export delimited using ./output/time_series/tsreg_op_appt_medium.csv, replace
> 
> * Hospitalisations
> local a "cardiac ild ra sepsis vasculitis"
> forvalues i=1/5 {
>     local c: word `i' of `a' 
>                 import delimited "./output/measures/join/measure_hosp_`c'_rat
> e.csv", clear      //get csv
>         putexcel set ./output/time_series/tsreg_tables, sheet(hosp_`c') modif
> y
>                 gen temp_date=date(date, "YMD")
>                 format temp_date %td
>                 gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
>                 gen month=mofd(temp_date)
>                 format month %tm
>                 drop temp_date
>                 *Value to rate per 100k
>                 gen rate = value*100000
>                 label variable rate "Rate of hospitalisations `c' per 100,000
> "
>                 *Set time series
>                 tsset month 
>                 newey rate i.postcovid, lag(1) force
>         *Export results
>         putexcel E1=("Number of obs") G1=(e(N))
>         putexcel E2=("F") G2=(e(F))
>         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
>         matrix a = r(table)'
>         putexcel A6 = matrix(a), rownames
>         putexcel save
>         *quietly margins postcovid
>         *marginsplot
>         *graph export ./output/time_series/margins_hosp_`c'.svg, as(svg) repl
> ace
>         itsa rate, trperiod(2020m4) figure single lag(1)
>         graph export ./output/time_series/itsa_`c'.svg, as(svg) replace
>         import excel using ./output/time_series/tsreg_tables.xlsx, sheet (hos
> p_`c') clear
>         export delimited using ./output/time_series/tsreg_hosp_`c'.csv, repla
> ce
>         }
> 
> * RA daycase
> import delimited "./output/measures/join/measure_hosp_ra_daycase_rate.csv", c
> lear       //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(hosp_ra_daycase) modify
> drop if ra_daycase==. | ra_daycase>=4
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> * Generate new population as all those with type of admission
> bys date: egen pop_new = total(population)
> * Calculate rate
> gen rate = (ra_hosp/pop_new)*100000
> label variable rate "Rate of op appts per 100,000"
> *Set time series
> tsset ra_daycase month
> newey rate i.ra_daycase##i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_hosp_ra_daycase.svg, as(svg) repla
> ce
> * Itsa model
> itsa rate, trperiod(2020m4) figure treatid(2) lag(1)
> graph export ./output/time_series/itsa_ra_daycase.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (hosp_ra_day
> case) clear
> export delimited using ./output/time_series/tsreg_hosp_ra_daycase.csv, replac
> e
> 
> import delimited "./output/measures/join/measure_med_gc_rate.csv", clear     
>    //get csv
> putexcel set ./output/time_series/tsreg_tables, sheet(med_gc) modify
> gen temp_date=date(date, "YMD")
> format temp_date %td
> gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
> gen month=mofd(temp_date)
> format month %tm
> drop temp_date
> *Value to rate per 100k
> gen rate = value*100000
> label variable rate "Rate of GC prescribing per 100,000"
> *Set time series
> tsset month 
> newey rate i.postcovid, lag(1) force
> *Export results
> putexcel E1=("Number of obs") G1=(e(N))
> putexcel E2=("F") G2=(e(F))
> putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
> matrix a = r(table)'
> putexcel A6 = matrix(a), rownames
> putexcel save
> *quietly margins postcovid
> *marginsplot
> *graph export ./output/time_series/margins_med_gc.svg, as(svg) replace
> itsa rate, trperiod(2020m4) figure single lag(1)
> graph export ./output/time_series/itsa_med_gc.svg, as(svg) replace
> import excel using ./output/time_series/tsreg_tables.xlsx, sheet (med_gc) cle
> ar
> export delimited using ./output/time_series/tsreg_med_gc.csv, replace

end of do-file

. . file open output using "/tmp/tmp.NU8WJSNV7S", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


