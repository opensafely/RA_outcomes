
. cap mkdir ./output/time_series

. 
. * Outpatient appointments amd hospitalisations
. * Autocorrelation indicates no autocorrelation for op_appt 
. foreach file in op_appt op_appt_all hosp_ra hosp_ra_emergency hosp_all med_gc
>  med_opioid_strong med_opioid_weak med_ssri med_nsaid {
  2.     import delimited "./output/measures/join/measure_`file'_rate.csv", cle
> ar    //get csv
  3.     gen temp_date=date(date, "YMD")
  4.     format temp_date %td
  5.     gen month=mofd(temp_date)
  6.     format month %tm
  7.     drop temp_date
  8.     *Value to percentage of population
.     gen percent = value*100
  9.     label variable percent "Percent of population"
 10.     *Set time series
.     tsset month 
 11.     itsa percent, trperiod(2020m4) figure single lag(1) posttrend
 12.     graph export ./output/time_series/itsa_`file'.svg, as(svg) replace
 13.     actest, lags(6)
 14.     }
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         70          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_op_appt.svg not found)
(file ./output/time_series/itsa_op_appt.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         70          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_op_appt_all.svg not found)
(file ./output/time_series/itsa_op_appt_all.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_hosp_ra.svg not found)
(file ./output/time_series/itsa_hosp_ra.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_hosp_ra_emergency.svg not found)
(file ./output/time_series/itsa_hosp_ra_emergency.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         30          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_hosp_all.svg not found)
(file ./output/time_series/itsa_hosp_all.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_gc.svg not found)
(file ./output/time_series/itsa_med_gc.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_opioid_strong.svg not found)
(file ./output/time_series/itsa_med_opioid_strong.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_opioid_weak.svg not found)
(file ./output/time_series/itsa_med_opioid_weak.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_ssri.svg not found)
(file ./output/time_series/itsa_med_ssri.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity
(4 vars, 36 obs)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month


        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         36
maximum lag: 1                                  F(  0,        32) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |          0  (omitted)
    _x2020m4 |          0  (omitted)
  _x_t2020m4 |          0  (omitted)
       _cons |         10          .        .       .            .           .
------------------------------------------------------------------------------


                    Postintervention Linear Trend: 2020m4

Treated: _b[_t]+_b[_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t              [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |          0          0        .       .            .           .
------------------------------------------------------------------------------
(note: file ./output/time_series/itsa_med_nsaid.svg not found)
(file ./output/time_series/itsa_med_nsaid.svg written in SVG format)

Cumby-Huizinga test for autocorrelation (Breusch-Godfrey)
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |          .      1        .  |   1 |          .      1        .
   1 -  2  |          .      2        .  |   2 |          .      1        .
   1 -  3  |          .      3        .  |   3 |          .      1        .
   1 -  4  |          .      4        .  |   4 |          .      1        .
   1 -  5  |          .      5        .  |   5 |          .      1        .
   1 -  6  |          .      6        .  |   6 |          .      1        .
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. * Medium of rheumatology outpatient appointments
. import delimited "./output/measures/join/measure_op_appt_medium_rate.csv", cl
> ear        //get csv
(5 vars, 360 obs)

. drop if op_appt_medium==. | op_appt_medium>=3
(288 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. * Generate new population as all those with medium described
. bys date: egen pop_new = total(population)

. * Calculate rate
. gen percent = (op_appt/pop_new)*100

. drop population

. label variable percent "Percent of population"

. *Set time series
. tsset op_appt_medium month 
       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

. itsa percent, trperiod(2020m4) treatid(2) figure lag(1) posttrend


       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         72
maximum lag: 1                                  F(  7,        64) =    1021.95
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |    .066693   .1304118     0.51   0.611    -.1938346    .3272205
          _z |  -23.15332   .7905725   -29.29   0.000    -24.73267   -21.57397
        _z_t |  -.0036539   .1486775    -0.02   0.980    -.3006714    .2933636
    _x2020m4 |  -.0814456   1.273868    -0.06   0.949    -2.626289    2.463398
  _x_t2020m4 |   -.101109   .1310796    -0.77   0.443    -.3629707    .1607526
  _z_x2020m4 |  -.2867158   1.466176    -0.20   0.846    -3.215738    2.642307
_z_x_t2020m4 |   .0337964   .1514537     0.22   0.824    -.2687672      .33636
       _cons |   46.15901    .687973    67.09   0.000     44.78462    47.53339
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |  -.0042735   .0265536    -0.16   0.873    -.0573204    .0487734
    Controls |  -.0344161   .0331641    -1.04   0.303     -.100669    .0318369
-------------+----------------------------------------------------------------
  Difference |   .0301425   .0424847     0.71   0.481    -.0547305    .1150156
------------------------------------------------------------------------------

. graph export ./output/time_series/itsa_op_appt_medium.svg, as(svg) replace
(note: file ./output/time_series/itsa_op_appt_medium.svg not found)
(file ./output/time_series/itsa_op_appt_medium.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |      0.002      1    0.9621 |   1 |      0.002      1    0.9621
   1 -  2  |      6.637      2    0.0362 |   2 |      6.637      1    0.0100
   1 -  3  |      8.347      3    0.0394 |   3 |      1.209      1    0.2715
   1 -  4  |      8.784      4    0.0667 |   4 |      1.743      1    0.1868
   1 -  5  |     10.826      5    0.0549 |   5 |      0.398      1    0.5280
   1 -  6  |     11.547      6    0.0729 |   6 |      1.244      1    0.2648
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. * Daycase admissions vs regular/ordinary 
. import delimited "./output/measures/join/measure_hosp_ra_daycase_rate.csv", c
> lear       //get csv
(5 vars, 216 obs)

. drop if ra_daycase==. | ra_daycase>=4
(108 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen month=mofd(temp_date)

. format month %tm

. gen postcovid=(temp_date>=date("23/03/2020", "DMY"))

. drop temp_date

. * Generate new population as all those with medium described
. bys date: egen pop_new = total(population)

. * Calculate percentage
. gen percent = (ra_hosp/pop_new)*100

. drop population

. label variable percent "Percent of population"

. *Set time series
. tsset ra_daycase month
       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

. newey percent ra_daycase##postcovid, lag(1) force 

Regression with Newey-West standard errors      Number of obs     =        108
maximum lag: 1                                  F(  5,       102) =    2822.89
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
     percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
  ra_daycase |
          2  |  -6.166407     .14613   -42.20   0.000    -6.456255   -5.876559
          3  |   -6.15404   .1538638   -40.00   0.000    -6.459228   -5.848852
             |
 1.postcovid |   .1037383   .1525777     0.68   0.498    -.1988988    .4063755
             |
  ra_daycase#|
   postcovid |
        2 1  |   -.086652   .1587378    -0.55   0.586    -.4015076    .2282036
        3 1  |  -.0687745   .1661641    -0.41   0.680    -.3983602    .2608112
             |
       _cons |   7.389751   .1438143    51.38   0.000     7.104496    7.675006
------------------------------------------------------------------------------

. * Itsa compared treat group to all other groups
. itsa percent, trperiod(2020m4) treatid(2) figure lag(1) posttrend


       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =        108
maximum lag: 1                                  F(  7,       100) =       5.46
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
    _percent |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
          _t |  -.0050525   .2389006    -0.02   0.983    -.4790244    .4689194
          _z |  -3.074602    1.60983    -1.91   0.059    -6.268458    .1192549
        _z_t |  -.0026883   .2389335    -0.01   0.991    -.4767256     .471349
    _x2020m4 |   .1420711   2.117502     0.07   0.947    -4.058994    4.343136
  _x_t2020m4 |   .0015847   .2600556     0.01   0.995    -.5143582    .5175277
  _z_x2020m4 |  -.1078957   2.118799    -0.05   0.959    -4.311533    4.095742
_z_x_t2020m4 |   .0090452   .2601312     0.03   0.972    -.5070476     .525138
       _cons |    4.34052   1.609594     2.70   0.008     1.147131     7.53391
------------------------------------------------------------------------------


                   Comparison of Linear Postintervention Trends: 2020m4


Treated    : _b[_t] + _b[_z_t] + _b[_x_t2020m4] + _b[_z_x_t2020m4]
Controls   : _b[_t] + _b[_x_t2020m4]
Difference : _b[_z_t] +  _b[_z_x_t2020m4]
------------------------------------------------------------------------------
Linear Trend |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
     Treated |   .0028892   .0048708     0.59   0.554    -.0067743    .0125527
    Controls |  -.0034677   .0929208    -0.04   0.970    -.1878199    .1808844
-------------+----------------------------------------------------------------
  Difference |   .0063569   .0930483     0.07   0.946    -.1782483    .1909622
------------------------------------------------------------------------------

. graph export ./output/time_series/itsa_hosp_ra_daycase.svg, as(svg) replace
(note: file ./output/time_series/itsa_hosp_ra_daycase.svg not found)
(file ./output/time_series/itsa_hosp_ra_daycase.svg written in SVG format)

. actest, lags(6)

Cumby-Huizinga test for autocorrelation
  H0: variable is MA process up to order q
  HA: serial correlation present at specified lags >q
-----------------------------------------------------------------------------
  H0: q=0 (serially uncorrelated)        |  H0: q=specified lag-1
  HA: s.c. present at range specified    |  HA: s.c. present at lag specified
-----------------------------------------+-----------------------------------
    lags   |      chi2      df     p-val | lag |      chi2      df     p-val
-----------+-----------------------------+-----+-----------------------------
   1 -  1  |    103.481      1    0.0000 |   1 |    103.481      1    0.0000
   1 -  2  |    103.656      2    0.0000 |   2 |     35.265      1    0.0000
   1 -  3  |    103.665      3    0.0000 |   3 |     21.308      1    0.0000
   1 -  4  |    103.676      4    0.0000 |   4 |     15.183      1    0.0001
   1 -  5  |    103.698      5    0.0000 |   5 |     11.761      1    0.0006
   1 -  6  |    103.700      6    0.0000 |   6 |      9.655      1    0.0019
-----------------------------------------------------------------------------
  Test allows predetermined regressors/instruments
  Test requires conditional homoskedasticity

. 
. 
. * Method of admission - elective vs emergency 
. * Graphs stratified by admission method
. import delimited using ./output/measures/join/measure_hosp_ra_elective_rate.c
> sv, numericcols(3) clear
(5 vars, 324 obs)

. * Drop if ra_elective missing or is mother-baby record
. drop if (ra_elective==. | ra_elective==31 | ra_elective==32 | ra_elective==82
>  | ra_elective==83)
(36 observations deleted)

. * generate binary variable for elective admissions 
. gen ra_elective_n = (ra_elective == 81 | ra_elective == 11 | ra_elective == 1
> 2 | ra_elective == 13)

. tab ra_elective*

ra_electiv |     ra_elective_n
         e |         0          1 |     Total
-----------+----------------------+----------
        11 |         0         36 |        36 
        12 |         0         36 |        36 
        13 |         0         36 |        36 
        21 |        36          0 |        36 
        22 |        36          0 |        36 
        23 |        36          0 |        36 
        24 |        36          0 |        36 
        25 |        36          0 |        36 
-----------+----------------------+----------
     Total |       180        108 |       288 

. * Update number of hospitalisations and population to combine all categories 
> combined
. bys date ra_elective_n: egen ra_hosp_n = total(ra_hosp)

. bys date ra_elective_n: egen population_n = total(population)

. drop ra_elective ra_hosp population value

. * Calculate proportion
. gen proportion = (ra_hosp_n/population_n)*100

. duplicates drop

Duplicates in terms of all variables

(216 observations deleted)

. * Format date
. gen dateA = date(date, "YMD")

. drop date

. format dateA %dD/M/Y

. gen month=mofd(dateA)

. format month %tm

. * reshape dataset so columns with rates for each ethnicity 
. reshape wide proportion population_n ra_hosp_n, i(dateA) j(ra_elective)
(note: j = 0 1)

Data                               long   ->   wide
-----------------------------------------------------------------------------
Number of obs.                       72   ->      36
Number of variables                   6   ->       8
j variable (2 values)     ra_elective_n   ->   (dropped)
xij variables:
                             proportion   ->   proportion0 proportion1
                           population_n   ->   population_n0 population_n1
                              ra_hosp_n   ->   ra_hosp_n0 ra_hosp_n1
-----------------------------------------------------------------------------

. describe

Contains data
  obs:            36                          
 vars:             8                          
-------------------------------------------------------------------------------
              storage   display    value
variable name   type    format     label      variable label
-------------------------------------------------------------------------------
dateA           float   %dD/M/Y               
ra_hosp_n0      float   %9.0g                 0 ra_hosp_n
population_n0   float   %9.0g                 0 population_n
proportion0     float   %9.0g                 0 proportion
ra_hosp_n1      float   %9.0g                 1 ra_hosp_n
population_n1   float   %9.0g                 1 population_n
proportion1     float   %9.0g                 1 proportion
month           float   %tm                   
-------------------------------------------------------------------------------
Sorted by: dateA
     Note: Dataset has changed since last saved.

. * Label strata 
. label var proportion0 "Emergency admission"

. label var proportion1 "Elective admission"

. *Set time series
. tsset month 
        time variable:  month, 2019m4 to 2022m3
                delta:  1 month

. itsa percent, trperiod(2020m4) figure single lag(1) posttrend
variable percent not found
r(111);

end of do-file
r(111);

end of do-file

r(111);


