
. cap mkdir ./output/time_series

. * Outpatient appointments
. local a "appt_first appt"

. forvalues i=1/2 {
  2.     local c: word `i' of `a' 
  3.                 import delimited "./output/measures/measure_op_`c'_rate.cs
> v", clear     //get csv
  4.                 putexcel set ./output/time_series/tsreg_tables, sheet(op_`
> c') modify
  5.         gen temp_date=date(date, "YMD")
  6.                 format temp_date %td
  7.                 gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
  8.                 gen month=mofd(temp_date)
  9.                 format month %tm
 10.                 drop temp_date
 11.                 *Value to rate per 100k
.                 gen rate = value*100000
 12.                 label variable rate "Rate of op `c' per 100,000"
 13.                 *Set time series
.                 tsset month 
 14.                 newey rate i.postcovid, lag(1) force
 15.         *Export results
.         putexcel E1=("Number of obs") G1=(e(N))
 16.         putexcel E2=("F") G2=(e(F))
 17.         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
 18.         matrix a = r(table)'
 19.         putexcel A6 = matrix(a), rownames
 20.         putexcel save
 21.         quietly margins postcovid
 22.         marginsplot
 23.         graph export ./output/time_series/margins_op_`c'.svg, as(svg) repl
> ace
 24.         import excel using ./output/time_series/tsreg_tables.xlsx, sheet (
> op_`c') clear
 25.         export delimited using ./output/time_series/tsreg_op_`c'.csv, repl
> ace
 26.         }
(4 vars, 37 obs)
        time variable:  month, 2019m4 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         37
maximum lag: 1                                  F(  0,        35) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      60000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_op_appt_first.svg not found)
(file ./output/time_series/margins_op_appt_first.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_op_appt_first.csv not found)
file ./output/time_series/tsreg_op_appt_first.csv saved
(4 vars, 37 obs)
        time variable:  month, 2019m4 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         37
maximum lag: 1                                  F(  0,        35) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      70000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_op_appt.svg not found)
(file ./output/time_series/margins_op_appt.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_op_appt.csv not found)
file ./output/time_series/tsreg_op_appt.csv saved

. 
. * Outpatient medium
. import delimited "./output/measures/measure_op_appt_medium_rate.csv", clear  
>    //get csv
(5 vars, 370 obs)

. putexcel set ./output/time_series/tsreg_tables, sheet(op_appt_medium) modify

. drop if op_appt_medium==. | op_appt_medium>=4
(259 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen postcovid=(temp_date>=date("23/03/2020", "DMY"))

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. * Generate new population as all those with medium described
. bys date: egen pop_new = total(population)

. * Calculate rate
. gen rate = (op_appt/pop_new)*100000

. label variable rate "Rate of op appts per 100,000"

. *Set time series
. tsset op_appt_medium month
       panel variable:  op_appt_medium (strongly balanced)
        time variable:  month, 2019m4 to 2022m4
                delta:  1 month

. newey rate i.op_appt_medium#i.postcovid, lag(1) force

Regression with Newey-West standard errors      Number of obs     =        111
maximum lag: 1                                  F(  5,       105) =     135.56
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
op_appt_me~m#|
   postcovid |
        1 1  |  -495.6141   1250.035    -0.40   0.693    -2974.203    1982.974
        2 0  |  -17723.64   1074.969   -16.49   0.000    -19855.11   -15592.18
        2 1  |  -17619.28   954.5005   -18.46   0.000    -19511.88   -15726.69
        3 0  |  -19240.65    1226.92   -15.68   0.000     -21673.4   -16807.89
        3 1  |  -19021.78   1039.114   -18.31   0.000    -21082.15   -16961.41
             |
       _cons |   35852.79   811.6163    44.17   0.000      34243.5    37462.07
------------------------------------------------------------------------------

. *Export results
. putexcel E1=("Number of obs") G1=(e(N))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E2=("F") G2=(e(F))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
file ./output/time_series/tsreg_tables.xlsx saved

. matrix a = r(table)'

. putexcel A6 = matrix(a), rownames
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel save

. quietly margins postcovid

. marginsplot

  Variables that uniquely identify margins: postcovid

. graph export ./output/time_series/margins_op_appt_medium.svg, as(svg) replace
(note: file ./output/time_series/margins_op_appt_medium.svg not found)
(file ./output/time_series/margins_op_appt_medium.svg written in SVG format)

. import excel using ./output/time_series/tsreg_tables.xlsx, sheet (op_appt_med
> ium) clear
(10 vars, 12 obs)

. export delimited using ./output/time_series/tsreg_op_appt_medium.csv, replace
(note: file ./output/time_series/tsreg_op_appt_medium.csv not found)
file ./output/time_series/tsreg_op_appt_medium.csv saved

. 
. * Hospitalisations
. local a "cardiac ild ra sepsis vasculitis"

. forvalues i=1/5 {
  2.     local c: word `i' of `a' 
  3.                 import delimited "./output/measures/measure_hosp_`c'_rate.
> csv", clear   //get csv
  4.         putexcel set ./output/time_series/tsreg_tables, sheet(hosp_`c') mo
> dify
  5.                 gen temp_date=date(date, "YMD")
  6.                 format temp_date %td
  7.                 gen postcovid=(temp_date>=date("23/03/2020", "DMY"))
  8.                 gen month=mofd(temp_date)
  9.                 format month %tm
 10.                 drop temp_date
 11.                 *Value to rate per 100k
.                 gen rate = value*100000
 12.                 label variable rate "Rate of hospitalisations `c' per 100,
> 000"
 13.                 *Set time series
.                 tsset month 
 14.                 newey rate i.postcovid, lag(1) force
 15.         *Export results
.         putexcel E1=("Number of obs") G1=(e(N))
 16.         putexcel E2=("F") G2=(e(F))
 17.         putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
 18.         matrix a = r(table)'
 19.         putexcel A6 = matrix(a), rownames
 20.         putexcel save
 21.         quietly margins postcovid
 22.         marginsplot
 23.         graph export ./output/time_series/margins_hosp_`c'.svg, as(svg) re
> place
 24.         import excel using ./output/time_series/tsreg_tables.xlsx, sheet (
> hosp_`c') clear
 25.         export delimited using ./output/time_series/tsreg_hosp_`c'.csv, re
> place
 26.         }
(4 vars, 50 obs)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_hosp_cardiac.svg not found)
(file ./output/time_series/margins_hosp_cardiac.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_hosp_cardiac.csv not found)
file ./output/time_series/tsreg_hosp_cardiac.csv saved
(4 vars, 50 obs)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_hosp_ild.svg not found)
(file ./output/time_series/margins_hosp_ild.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_hosp_ild.csv not found)
file ./output/time_series/tsreg_hosp_ild.csv saved
(4 vars, 50 obs)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_hosp_ra.svg not found)
(file ./output/time_series/margins_hosp_ra.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_hosp_ra.csv not found)
file ./output/time_series/tsreg_hosp_ra.csv saved
(4 vars, 50 obs)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_hosp_sepsis.svg not found)
(file ./output/time_series/margins_hosp_sepsis.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_hosp_sepsis.csv not found)
file ./output/time_series/tsreg_hosp_sepsis.csv saved
(4 vars, 50 obs)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved
file ./output/time_series/tsreg_tables.xlsx saved

  Variables that uniquely identify margins: postcovid
(note: file ./output/time_series/margins_hosp_vasculitis.svg not found)
(file ./output/time_series/margins_hosp_vasculitis.svg written in SVG format)
(10 vars, 8 obs)
(note: file ./output/time_series/tsreg_hosp_vasculitis.csv not found)
file ./output/time_series/tsreg_hosp_vasculitis.csv saved

. 
. * RA daycase
. import delimited "./output/measures/measure_hosp_ra_daycase_rate.csv", clear 
>    //get csv
(5 vars, 300 obs)

. putexcel set ./output/time_series/tsreg_tables, sheet(hosp_ra_daycase) modify

. drop if ra_daycase==. | ra_daycase==5
(100 observations deleted)

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen postcovid=(temp_date>=date("23/03/2020", "DMY"))

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. * Generate new population as all those with type of admission
. bys date: egen pop_new = total(population)

. * Calculate rate
. gen rate = (ra_hosp/pop_new)*100000

. label variable rate "Rate of op appts per 100,000"

. *Set time series
. tsset ra_daycase month
       panel variable:  ra_daycase (strongly balanced)
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

. newey rate i.ra_daycase#i.postcovid, lag(1) force

Regression with Newey-West standard errors      Number of obs     =        200
maximum lag: 1                                  F(  7,       192) =     204.36
                                                Prob > F          =     0.0000

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
  ra_daycase#|
   postcovid |
        1 1  |   -125.633   291.0885    -0.43   0.667    -699.7749    448.5089
        2 0  |  -5783.317   216.0454   -26.77   0.000    -6209.444    -5357.19
        2 1  |  -5635.059   209.0031   -26.96   0.000    -6047.297   -5222.822
        3 0  |  -5780.608   207.1856   -27.90   0.000     -6189.26   -5371.956
        3 1  |  -5716.609   207.3754   -27.57   0.000    -6125.636   -5307.583
        4 0  |  -5772.783   199.5163   -28.93   0.000    -6166.309   -5379.258
        4 1  |  -5723.694   233.6752   -24.49   0.000    -6184.594   -5262.794
             |
       _cons |   6788.627   187.5038    36.21   0.000     6418.795    7158.458
------------------------------------------------------------------------------

. *Export results
. putexcel E1=("Number of obs") G1=(e(N))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E2=("F") G2=(e(F))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
file ./output/time_series/tsreg_tables.xlsx saved

. matrix a = r(table)'

. putexcel A6 = matrix(a), rownames
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel save

. quietly margins postcovid

. marginsplot

  Variables that uniquely identify margins: postcovid

. graph export ./output/time_series/margins_hosp_ra_daycase.svg, as(svg) replac
> e
(note: file ./output/time_series/margins_hosp_ra_daycase.svg not found)
(file ./output/time_series/margins_hosp_ra_daycase.svg written in SVG format)

. import excel using ./output/time_series/tsreg_tables.xlsx, sheet (hosp_ra_day
> case) clear
(10 vars, 14 obs)

. export delimited using ./output/time_series/tsreg_hosp_ra_daycase.csv, replac
> e
(note: file ./output/time_series/tsreg_hosp_ra_daycase.csv not found)
file ./output/time_series/tsreg_hosp_ra_daycase.csv saved

. 
. import delimited "./output/measures/measure_med_gc_rate.csv", clear     //get
>  csv
(4 vars, 50 obs)

. putexcel set ./output/time_series/tsreg_tables, sheet(med_gc) modify

. gen temp_date=date(date, "YMD")

. format temp_date %td

. gen postcovid=(temp_date>=date("23/03/2020", "DMY"))

. gen month=mofd(temp_date)

. format month %tm

. drop temp_date

. *Value to rate per 100k
. gen rate = value*100000

. label variable rate "Rate of GC prescribing per 100,000"

. *Set time series
. tsset month 
        time variable:  month, 2018m3 to 2022m4
                delta:  1 month

. newey rate i.postcovid, lag(1) force

Regression with Newey-West standard errors      Number of obs     =         50
maximum lag: 1                                  F(  0,        48) =          .
                                                Prob > F          =          .

------------------------------------------------------------------------------
             |             Newey-West
        rate |      Coef.   Std. Err.      t    P>|t|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
 1.postcovid |          0  (omitted)
       _cons |      10000          .        .       .            .           .
------------------------------------------------------------------------------

. *Export results
. putexcel E1=("Number of obs") G1=(e(N))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E2=("F") G2=(e(F))
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel E3=("Prob > F") G3=(Ftail(e(df_m), e(df_r), e(F)))
file ./output/time_series/tsreg_tables.xlsx saved

. matrix a = r(table)'

. putexcel A6 = matrix(a), rownames
file ./output/time_series/tsreg_tables.xlsx saved

. putexcel save

. quietly margins postcovid

. marginsplot

  Variables that uniquely identify margins: postcovid

. graph export ./output/time_series/margins_med_gc.svg, as(svg) replace
(note: file ./output/time_series/margins_med_gc.svg not found)
(file ./output/time_series/margins_med_gc.svg written in SVG format)

. import excel using ./output/time_series/tsreg_tables.xlsx, sheet (med_gc) cle
> ar
(10 vars, 8 obs)

. export delimited using ./output/time_series/tsreg_med_gc.csv, replace
(note: file ./output/time_series/tsreg_med_gc.csv not found)
file ./output/time_series/tsreg_med_gc.csv saved

. 
end of do-file

. . file open output using "/tmp/tmp.A5jtyYXGei", write text replace

. . file write output "success" 

. . file close output

. 
end of do-file


